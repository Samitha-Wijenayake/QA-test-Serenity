name: Serenity BDD Automation

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  serenity-tests:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Get the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup Java 21 (required by your JAR)
      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 3️⃣ Make jar executable (Linux runner)
      - name: Make JAR executable
        run: chmod +x app/qa-training-app.jar

      # 4️⃣ Start the application
      - name: Start QA Training App
        run: |
          java -jar app/qa-training-app.jar > app.log 2>&1 &
          echo "Waiting for app to start..."
          sleep 30

      # 5️⃣ Run Serenity tests
      - name: Run Serenity Tests
        run: |
          run: mvn clean verify -DtestFailureIgnore=true -Dwebdriver.autodriver=true

      # 6️⃣ Upload Serenity Report
      - name: Upload Serenity Report
        uses: actions/upload-artifact@v4
        with:
          name: serenity-report
          path: target/site/serenity

      # 7️⃣ Upload app logs (if tests fail)
      - name: Upload Application Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: application-log
          path: app.log
